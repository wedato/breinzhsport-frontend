import{__rest as e}from"tslib";import i,{useState as t,useEffect as r,useCallback as s,useMemo as o}from"react";import{Storage as a}from"@aws-amplify/storage";import{translate as l,uploadFile as m,isValidExtension as n}from"@aws-amplify/ui";import{Logger as p}from"aws-amplify";import"../../../primitives/Alert/Alert.mjs";import"../../../primitives/Autocomplete/Autocomplete.mjs";import"../../../primitives/Badge/Badge.mjs";import{Button as c}from"../../../primitives/Button/Button.mjs";import"../../../primitives/ButtonGroup/ButtonGroup.mjs";import"../../../primitives/Card/Card.mjs";import"../../../primitives/CheckboxField/CheckboxField.mjs";import"../../../primitives/Collection/Collection.mjs";import"../../../primitives/Divider/Divider.mjs";import"../../../primitives/Expander/Expander.mjs";import"../../../primitives/Expander/ExpanderItem.mjs";import"../../../primitives/FieldGroupIcon/FieldGroupIcon.mjs";import"../../../primitives/FieldGroupIcon/FieldGroupIconButton.mjs";import"../../../primitives/Flex/Flex.mjs";import"../../../primitives/Grid/Grid.mjs";import"../../../primitives/Heading/Heading.mjs";import"../../../primitives/HighlightMatch/HighlightMatch.mjs";import"../../../primitives/Icon/Icon.mjs";import"../../../primitives/Image/Image.mjs";import"../../../primitives/Link/Link.mjs";import"../../../primitives/Loader/Loader.mjs";import"../../../primitives/Menu/Menu.mjs";import"../../../primitives/Menu/MenuButton.mjs";import"../../../primitives/Menu/MenuItem.mjs";import"../../../primitives/Pagination/Pagination.mjs";import"../../../primitives/PasswordField/PasswordField.mjs";import"../../../primitives/PhoneNumberField/PhoneNumberField.mjs";import"../../../primitives/Placeholder/Placeholder.mjs";import"../../../primitives/Radio/Radio.mjs";import"../../../primitives/RadioGroupField/RadioGroupField.mjs";import"../../../primitives/Rating/Rating.mjs";import"../../../primitives/ScrollView/ScrollView.mjs";import"../../../primitives/SearchField/SearchField.mjs";import"../../../primitives/SelectField/SelectField.mjs";import"../../../primitives/SliderField/SliderField.mjs";import"../../../primitives/StepperField/StepperField.mjs";import"../../../primitives/SwitchField/SwitchField.mjs";import"../../../primitives/Table/Table.mjs";import"../../../primitives/Table/TableBody.mjs";import"../../../primitives/Table/TableCell.mjs";import"../../../primitives/Table/TableFoot.mjs";import"../../../primitives/Table/TableHead.mjs";import"../../../primitives/Table/TableRow.mjs";import"../../../primitives/Tabs/Tabs.mjs";import"../../../primitives/Text/Text.mjs";import"../../../primitives/TextAreaField/TextAreaField.mjs";import"../../../primitives/TextField/TextField.mjs";import"../../../primitives/ToggleButton/ToggleButton.mjs";import"../../../primitives/ToggleButtonGroup/ToggleButtonGroup.mjs";import"../../../primitives/View/View.mjs";import{VisuallyHidden as d}from"../../../primitives/VisuallyHidden/VisuallyHidden.mjs";import{ComponentClassNames as u}from"../../../primitives/shared/constants.mjs";import v from"./hooks/useFileUploader/useFileUploader.mjs";import{UploadPreviewer as g}from"./UploadPreviewer/index.mjs";import{UploadDropZone as j}from"./UploadDropZone/index.mjs";import{UploadTracker as f}from"./UploadTracker/index.mjs";import{FileState as h}from"./types.mjs";import{useDeprecationWarning as F}from"../../../hooks/useDeprecationWarning.mjs";const S=e=>"function"==typeof(null==e?void 0:e.resume),b=new p("AmplifyUI:Storage");function T(p){var{acceptedFileTypes:T,shouldAutoProceed:w=!1,isPreviewerVisible:E,maxFileCount:I,maxSize:x,hasMultipleFiles:C=!0,onError:O,onSuccess:P,showImages:k=!0,accessLevel:R,variation:y="drop",isResumable:M=!1}=p,B=e(p,["acceptedFileTypes","shouldAutoProceed","isPreviewerVisible","maxFileCount","maxSize","hasMultipleFiles","onError","onSuccess","showImages","accessLevel","variation","isResumable"]);F({shouldWarn:!0,message:"FileUploader has exited Dev Preview and was renamed to StorageManager with some API changes. Please migrate to the StorageManager component, as the FileUploader component is no longer supported and will be removed in a future major release. https://ui.docs.amplify.aws/react/connected-components/storage/storagemanager"}),T&&R||b.warn("FileUploader requires accessLevel and acceptedFileTypes props");const[D,G]=t(!1),[A,U]=t(!1),L=v({maxSize:x,acceptedFileTypes:T,hasMultipleFiles:C,isLoading:D,setAutoLoad:U}),{addTargetFiles:N,fileStatuses:V,inDropZone:H,setFileStatuses:Z,setShowPreviewer:z,showPreviewer:W}=L,q=e(L,["addTargetFiles","fileStatuses","inDropZone","setFileStatuses","setShowPreviewer","showPreviewer"]),J=Math.floor(V.reduce(((e,i)=>{var t;return e+(null!==(t=null==i?void 0:i.percentage)&&void 0!==t?t:0)}),0)/V.length),K=0!==V.length&&V.every((e=>100===(null==e?void 0:e.percentage))),Q=V.filter((e=>100!==e.percentage)).length>I;r((()=>{100===Math.floor(J)&&G(!1)}),[J]),r((()=>{z(E)}),[z,E]);const X=s((e=>i=>{Z((t=>{const r=Object.assign({},t[e]),s=0!==i.total?Math.floor(i.loaded/i.total*100):100,o=100!==s?h.LOADING:h.SUCCESS,a=Object.assign(Object.assign({},r),{percentage:s,fileState:o});return t[e]=a,[...t]}))}),[Z]),Y=s((e=>i=>{Z((t=>{const r=Object.assign({},t[e]),s=Object.assign(Object.assign({},r),{fileState:"error",fileErrors:l(i.toString())});return t[e]=s,[...t]})),G(!1),"function"==typeof O&&O(i)}),[O,Z]),$=s((e=>function(){const i=V[e];S(i.uploadTask)&&i.uploadTask.pause();const t=[...V];t[e]=Object.assign(Object.assign({},i),{fileState:h.PAUSED}),Z(t)}),[V,Z]),_=s((e=>function(){const i=V[e];S(i.uploadTask)&&i.uploadTask.resume();const t=[...V];t[e]=Object.assign(Object.assign({},i),{fileState:h.RESUME}),Z(t)}),[V,Z]),ee=s((()=>{G(!0);const e=[];V.forEach(((i,t)=>{if((null==i?void 0:i.fileState)===h.SUCCESS)return;const r=m(Object.assign({file:i.file,fileName:i.name,level:R,isResumable:M,progressCallback:X(t),errorCallback:Y(t),completeCallback:P},B));S(r)&&M&&e.push(r)})),Z((i=>i.map(((i,t)=>{var r;return Object.assign(Object.assign({},i),{uploadTask:null==e?void 0:e[t],fileState:i.fileState===h.INIT?h.LOADING:i.fileState,percentage:null!==(r=i.percentage)&&void 0!==r?r:0})}))))}),[V,Z,R,M,X,Y,P,B]),ie=s((e=>{if(!e.target.files||0===e.target.files.length)return;const{files:i}=e.target;N([...i])>0&&(z(!0),U(!0))}),[N,z]),te=s((()=>{z(!1),Z([])}),[Z,z]),re=s((e=>()=>{const{fileState:i,uploadTask:t}=V[e];"loading"===i&&S(t)&&(a.cancel(t),G(!1));const r=V.filter(((i,t)=>t!==e));Z(r)}),[V,Z]),se=s((e=>i=>{if(0===i.trim().length)return;const t=[...V],r=V[e],s=n(i,r.file.name);t[e]=Object.assign(Object.assign({},r),{name:i,fileState:s?h.INIT:h.ERROR,fileErrors:s?void 0:l("Extension not allowed")}),Z(t)}),[V,Z]),oe=s(((e,i)=>{Z((t=>{const r=[...t],s=r[e],o=n(s.name,s.file.name)?h.INIT:h.ERROR,a=i===h.INIT?o:i;return r[e]=Object.assign(Object.assign({},s),{fileState:a}),r}))}),[Z]),ae=s((e=>()=>{oe(e,h.INIT)}),[oe]),le=s((e=>i=>{oe(e,h.EDITING)}),[oe]);r((()=>{w&&A&&!Q&&(ee(),U(!1))}),[w,ee,A,Q]);const me=i.useRef(null),ne=null==T?void 0:T.join(),pe=o((()=>i.createElement(i.Fragment,null,i.createElement(c,{className:u.FileUploaderDropZoneButton,isDisabled:D,onClick:()=>{var e;null===(e=null==me?void 0:me.current)||void 0===e||e.click(),me.current.value=""},size:"small"},l("Browse files")),i.createElement(d,null,i.createElement("input",{type:"file",tabIndex:-1,ref:me,onChange:ie,multiple:C,accept:ne})))),[D,ie,C,ne]);return W?i.createElement(g,{dropZone:i.createElement(j,Object.assign({},q,{inDropZone:H}),pe),fileStatuses:V,isLoading:D,isSuccessful:K,hasMaxFilesError:Q,maxFileCount:I,onClear:te,onFileClick:ee,aggregatePercentage:J},null==V?void 0:V.map(((e,t)=>{var r;return i.createElement(f,{errorMessage:null==e?void 0:e.fileErrors,file:e.file,fileState:null==e?void 0:e.fileState,hasImage:null===(r=e.file)||void 0===r?void 0:r.type.startsWith("image/"),showImage:k,key:t,name:e.name,onCancel:re(t),onCancelEdit:ae(t),onPause:$(t),onResume:_(t),onSaveEdit:se(t),onStartEdit:le(t),percentage:e.percentage,isResumable:M})}))):"button"===y?pe:i.createElement(j,Object.assign({},q,{inDropZone:H}),pe)}export{T as FileUploader};
